<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor OCR de PDF - Processos Digitalizados</title>

    <!-- Vue 3 e Vuetify -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet">

    <style>
        #app {
            font-family: 'Roboto', sans-serif;
        }

        .extracted-text {
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }

        .drop-zone {
            border: 2px dashed #1976d2;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            background: linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6),
                        linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .drop-zone.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .stats-card {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-app-bar color="primary" dark>
                <v-toolbar-title>
                    <v-icon>mdi-file-pdf-box</v-icon>
                    Conversor OCR de PDF - Processos Digitalizados
                </v-toolbar-title>
            </v-app-bar>

            <v-main>
                <v-container>
                    <!-- Upload de Arquivo -->
                    <v-card class="mb-4">
                        <v-card-title>
                            <v-icon class="mr-2">mdi-upload</v-icon>
                            Carregar PDF
                        </v-card-title>
                        <v-card-text>
                            <div
                                class="drop-zone"
                                :class="{ 'dragover': isDragging }"
                                @drop.prevent="handleDrop"
                                @dragover.prevent="isDragging = true"
                                @dragleave.prevent="isDragging = false"
                            >
                                <v-icon size="64" color="primary">mdi-cloud-upload</v-icon>
                                <h3>Arraste um PDF aqui ou clique para selecionar</h3>
                                <input
                                    type="file"
                                    ref="fileInput"
                                    accept="application/pdf"
                                    @change="handleFileSelect"
                                    style="display: none"
                                />
                                <v-btn
                                    color="primary"
                                    class="mt-4"
                                    @click="$refs.fileInput.click()"
                                >
                                    <v-icon left>mdi-file-pdf-box</v-icon>
                                    Selecionar PDF
                                </v-btn>

                                <div v-if="pdfFile" class="mt-4">
                                    <v-chip color="success" class="mr-2">
                                        <v-icon left>mdi-file-check</v-icon>
                                        {{ pdfFile.name }}
                                    </v-chip>
                                    <v-chip>{{ (pdfFile.size / 1024 / 1024).toFixed(2) }} MB</v-chip>
                                </div>
                            </div>
                        </v-card-text>
                    </v-card>

                    <!-- Configurações -->
                    <v-card class="mb-4" v-if="pdfFile && !processing">
                        <v-card-title>
                            <v-icon class="mr-2">mdi-cog</v-icon>
                            Configurações de OCR
                        </v-card-title>
                        <v-card-text>
                            <v-row>
                                <v-col cols="12" md="4">
                                    <v-select
                                        v-model="ocrLanguage"
                                        :items="languages"
                                        item-title="text"
                                        item-value="value"
                                        label="Idioma"
                                        prepend-icon="mdi-translate"
                                    ></v-select>
                                </v-col>
                                <v-col cols="12" md="4">
                                    <v-select
                                        v-model="ocrMode"
                                        :items="modes"
                                        item-title="text"
                                        item-value="value"
                                        label="Modo de Qualidade"
                                        prepend-icon="mdi-speedometer"
                                    ></v-select>
                                </v-col>
                                <v-col cols="12" md="4">
                                    <v-select
                                        v-model="outputFormat"
                                        :items="outputFormats"
                                        item-title="text"
                                        item-value="value"
                                        label="Formato de Saída"
                                        prepend-icon="mdi-file-document"
                                    ></v-select>
                                </v-col>
                            </v-row>

                            <!-- Seletor de Motor OCR -->
                            <v-row>
                                <v-col cols="12">
                                    <v-card variant="outlined" class="mb-3">
                                        <v-card-title class="text-subtitle-1">
                                            <v-icon left>mdi-engine</v-icon>
                                            Motor OCR
                                        </v-card-title>
                                        <v-card-text>
                                            <v-radio-group v-model="selectedOcrEngine" inline>
                                                <v-radio
                                                    v-for="engine in ocrEngines"
                                                    :key="engine.id"
                                                    :value="engine.id"
                                                    :disabled="!engine.available"
                                                >
                                                    <template v-slot:label>
                                                        <div class="d-flex flex-column">
                                                            <div class="d-flex align-center">
                                                                <span>{{ engine.icon }} {{ engine.name }}</span>
                                                                <v-chip
                                                                    v-if="engine.recommended"
                                                                    size="x-small"
                                                                    color="success"
                                                                    class="ml-2"
                                                                >Recomendado</v-chip>
                                                                <v-chip
                                                                    v-if="engine.isDefault"
                                                                    size="x-small"
                                                                    color="primary"
                                                                    variant="outlined"
                                                                    class="ml-2"
                                                                >Padrão</v-chip>
                                                                <v-chip
                                                                    v-if="!engine.available"
                                                                    size="x-small"
                                                                    color="warning"
                                                                    class="ml-2"
                                                                >Configurar</v-chip>
                                                            </div>
                                                            <div class="text-caption text-grey">
                                                                {{ engine.description }} · Qualidade: {{ engine.quality }} · {{ engine.cost }}
                                                            </div>
                                                        </div>
                                                    </template>
                                                </v-radio>
                                            </v-radio-group>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                            </v-row>

                            <v-row>
                                <v-col cols="12" md="6">
                                    <v-switch
                                        v-model="enhanceImage"
                                        label="Melhorar Qualidade da Imagem"
                                        color="primary"
                                    ></v-switch>
                                </v-col>
                                <v-col cols="12" md="6">
                                    <v-switch
                                        v-model="preserveLayout"
                                        label="Preservar Layout Original"
                                        color="primary"
                                    ></v-switch>
                                </v-col>
                            </v-row>
                        </v-card-text>
                        <v-card-actions>
                            <v-btn
                                color="primary"
                                size="large"
                                block
                                @click="startOCR"
                            >
                                <v-icon left>mdi-text-recognition</v-icon>
                                Iniciar OCR
                            </v-btn>
                        </v-card-actions>
                    </v-card>

                    <!-- Progresso -->
                    <v-card class="mb-4" v-if="processing">
                        <v-card-title>
                            <v-icon class="mr-2">mdi-cog-refresh</v-icon>
                            Processando...
                        </v-card-title>
                        <v-card-text>
                            <div class="text-center mb-4">
                                <v-progress-circular
                                    :model-value="progress"
                                    :size="100"
                                    :width="10"
                                    color="primary"
                                >
                                    {{ Math.round(progress) }}%
                                </v-progress-circular>
                            </div>
                            <p class="text-center">{{ progressMessage }}</p>
                            <v-progress-linear
                                :model-value="progress"
                                color="primary"
                                height="8"
                                rounded
                            ></v-progress-linear>

                            <div v-if="performanceMetrics.pagesProcessed > 0" class="mt-4">
                                <v-chip class="mr-2" color="info">
                                    {{ performanceMetrics.pagesProcessed }} / {{ totalPages }} páginas
                                </v-chip>
                                <v-chip class="mr-2" color="success">
                                    {{ performanceMetrics.pagesPerSecond }} pág/s
                                </v-chip>
                                <v-chip color="warning">
                                    {{ performanceMetrics.estimatedTimeRemaining }}s restantes
                                </v-chip>
                            </div>
                        </v-card-text>
                    </v-card>

                    <!-- Resultados -->
                    <v-card v-if="ocrCompleted" class="mb-4">
                        <v-card-title>
                            <v-icon class="mr-2">mdi-check-circle</v-icon>
                            Resultado do OCR
                        </v-card-title>
                        <v-card-text>
                            <!-- Estatísticas -->
                            <v-row class="mb-4">
                                <v-col cols="6" md="3">
                                    <v-card class="stats-card">
                                        <v-card-text class="text-center">
                                            <div class="text-h4">{{ statistics.pageCount }}</div>
                                            <div class="text-caption">Páginas</div>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                                <v-col cols="6" md="3">
                                    <v-card class="stats-card">
                                        <v-card-text class="text-center">
                                            <div class="text-h4">{{ statistics.totalWords }}</div>
                                            <div class="text-caption">Palavras</div>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                                <v-col cols="6" md="3">
                                    <v-card class="stats-card">
                                        <v-card-text class="text-center">
                                            <div class="text-h4">{{ statistics.averageConfidence.toFixed(1) }}%</div>
                                            <div class="text-caption">Confiança</div>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                                <v-col cols="6" md="3">
                                    <v-card class="stats-card">
                                        <v-card-text class="text-center">
                                            <div class="text-h4">{{ processingTime }}s</div>
                                            <div class="text-caption">Tempo</div>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                            </v-row>

                            <!-- Texto Extraído -->
                            <v-card>
                                <v-card-title>Texto Extraído</v-card-title>
                                <v-card-text>
                                    <div class="extracted-text">{{ extractedText }}</div>
                                </v-card-text>
                            </v-card>
                        </v-card-text>
                        <v-card-actions>
                            <v-btn color="primary" @click="downloadText">
                                <v-icon left>mdi-download</v-icon>
                                Baixar TXT
                            </v-btn>
                            <v-btn color="success" @click="downloadSearchablePDF" v-if="searchablePdfData">
                                <v-icon left>mdi-file-pdf-box</v-icon>
                                Baixar PDF Pesquisável
                            </v-btn>
                            <v-btn color="secondary" @click="resetApp">
                                <v-icon left>mdi-refresh</v-icon>
                                Processar Outro
                            </v-btn>
                        </v-card-actions>
                    </v-card>

                    <!-- Alertas -->
                    <v-alert
                        v-if="alert.show"
                        :type="alert.type"
                        closable
                        @click:close="alert.show = false"
                    >
                        {{ alert.message }}
                    </v-alert>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>

    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify();

        const app = createApp({
            data() {
                return {
                    // Arquivo
                    pdfFile: null,
                    isDragging: false,

                    // Configurações
                    ocrLanguage: 'por',
                    ocrMode: 'accurate',
                    outputFormat: 'searchable_pdf',
                    enhanceImage: true,
                    preserveLayout: true,
                    selectedOcrEngine: null, // Motor OCR selecionado

                    // Motores OCR disponíveis
                    ocrEngines: [],

                    languages: [
                        { text: 'Português', value: 'por' },
                        { text: 'Inglês', value: 'eng' },
                        { text: 'Espanhol', value: 'spa' }
                    ],

                    modes: [
                        { text: 'Rápido (Fast)', value: 'fast' },
                        { text: 'Balanceado (Accurate)', value: 'accurate' },
                        { text: 'Melhor Qualidade (Best)', value: 'best' }
                    ],

                    outputFormats: [
                        { text: 'PDF Pesquisável', value: 'searchable_pdf' },
                        { text: 'Apenas Texto', value: 'text' },
                        { text: 'Ambos', value: 'both' }
                    ],

                    // Estado
                    processing: false,
                    progress: 0,
                    progressMessage: '',
                    ocrCompleted: false,
                    totalPages: 0,

                    // Resultados
                    extractedText: '',
                    searchablePdfData: null,
                    processingTime: 0,

                    // Métricas
                    performanceMetrics: {
                        pagesProcessed: 0,
                        pagesPerSecond: 0,
                        estimatedTimeRemaining: 0
                    },

                    statistics: {
                        pageCount: 0,
                        totalWords: 0,
                        averageConfidence: 0
                    },

                    // Alertas
                    alert: {
                        show: false,
                        type: 'info',
                        message: ''
                    }
                };
            },

            methods: {
                handleDrop(e) {
                    this.isDragging = false;
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        this.pdfFile = files[0];
                        this.showMessage('PDF carregado com sucesso!', 'success');
                    } else {
                        this.showMessage('Por favor, selecione um arquivo PDF válido', 'error');
                    }
                },

                handleFileSelect(e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        this.pdfFile = files[0];
                        this.showMessage('PDF carregado com sucesso!', 'success');
                    }
                },

                async startOCR() {
                    if (!this.pdfFile) {
                        this.showMessage('Por favor, selecione um PDF primeiro', 'error');
                        return;
                    }

                    this.processing = true;
                    this.progress = 0;
                    this.progressMessage = 'Enviando PDF para o servidor...';
                    this.ocrCompleted = false;

                    try {
                        // Criar FormData
                        const formData = new FormData();
                        formData.append('pdf', this.pdfFile);
                        formData.append('language', this.ocrLanguage);
                        formData.append('mode', this.ocrMode);
                        formData.append('outputFormat', this.outputFormat);
                        formData.append('enhanceImage', this.enhanceImage);
                        formData.append('preserveLayout', this.preserveLayout);

                        // Adicionar motor OCR selecionado (se houver)
                        if (this.selectedOcrEngine) {
                            formData.append('ocrEngine', this.selectedOcrEngine);
                        }

                        // Enviar para API com progress
                        const response = await fetch('http://localhost:3000/api/process-pdf-parallel', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('Erro no processamento: ' + response.statusText);
                        }

                        const result = await response.json();

                        // Processar resultado
                        this.extractedText = result.text;
                        this.searchablePdfData = result.searchablePdf;
                        this.statistics = result.statistics;
                        this.totalPages = result.statistics.pageCount;
                        this.processingTime = result.statistics.processingTime;

                        this.ocrCompleted = true;
                        this.progress = 100;
                        this.showMessage('✅ OCR concluído com sucesso!', 'success');

                        // CORREÇÃO: Mover processing = false para o final do try
                        // (estava no finally, sendo executado antes do fetch terminar)
                        this.processing = false;

                    } catch (error) {
                        console.error('Erro no OCR:', error);
                        this.showMessage('Erro no processamento: ' + error.message, 'error');
                        this.processing = false; // Manter aqui também para caso de erro
                    }
                },

                downloadText() {
                    const blob = new Blob([this.extractedText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.pdfFile.name.replace('.pdf', '_OCR.txt');
                    a.click();
                    URL.revokeObjectURL(url);
                },

                downloadSearchablePDF() {
                    if (!this.searchablePdfData) return;

                    // Converter base64 para blob
                    const byteCharacters = atob(this.searchablePdfData);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.pdfFile.name.replace('.pdf', '_OCR_Pesquisavel.pdf');
                    a.click();
                    URL.revokeObjectURL(url);
                },

                resetApp() {
                    this.pdfFile = null;
                    this.processing = false;
                    this.progress = 0;
                    this.progressMessage = '';
                    this.ocrCompleted = false;
                    this.extractedText = '';
                    this.searchablePdfData = null;
                    this.totalPages = 0;
                    this.processingTime = 0;
                    this.performanceMetrics = {
                        pagesProcessed: 0,
                        pagesPerSecond: 0,
                        estimatedTimeRemaining: 0
                    };
                    this.statistics = {
                        pageCount: 0,
                        totalWords: 0,
                        averageConfidence: 0
                    };
                },

                showMessage(message, type = 'info') {
                    this.alert.message = message;
                    this.alert.type = type;
                    this.alert.show = true;
                },

                async loadAvailableEngines() {
                    try {
                        const response = await fetch('http://localhost:3000/api/ocr-engines');
                        const data = await response.json();

                        if (data.success) {
                            this.ocrEngines = data.engines;

                            // Selecionar automaticamente o motor padrão ou o recomendado
                            const defaultEngine = this.ocrEngines.find(e => e.isDefault);
                            const recommendedEngine = this.ocrEngines.find(e => e.recommended && e.available);

                            this.selectedOcrEngine = recommendedEngine ? recommendedEngine.id : (defaultEngine ? defaultEngine.id : null);

                            console.log('Motores OCR carregados:', this.ocrEngines);
                            console.log('Motor selecionado:', this.selectedOcrEngine);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar motores OCR:', error);
                        this.showMessage('Erro ao carregar motores OCR disponíveis', 'warning');
                    }
                }
            },

            mounted() {
                // Carregar motores OCR disponíveis ao iniciar
                this.loadAvailableEngines();
            }
        });

        app.use(vuetify).mount('#app');
    </script>
</body>
</html>
